YUI.add("webrtc",function(e,t){function S(){}var n=io.connect("/"),r,i,s,o,u=-1,a={url:"stun:stun.l.google.com:19302"},f=null,l=[],c="",h=!1,p=null,d=[],v=!1,m=[],g=!0,y=[],b=[],w=null,E=[];S.prototype={startStream:function(e,t){var n=this;(e==="both"||e==="media"||typeof e===undefined)&&n._startLocalStream(function(){n._makeConnection(t)})},onMessage:function(e){var t;for(t=0;t<b.length;t++)b[t].onmessage=e},send:function(e){var t;for(t=0;t<b.length;t++)b[t]!==undefined?b[t].send(e):m.push(e)},sendFile:function(e){var t=this,n=new FileReader;n.onload=function(n){var r=document.getElementById(e).value.split(/(\/|\\)/).pop();t.send(n.target.result)},n.readAsText(document.getElementById(e).files[0])},setLocal:function(e){f=document.getElementById(e)},addRemote:function(e){l.push(document.getElementById(e))},pause:function(){i.removeStream(p),this._updateDescription(),h=!1},isStreaming:function(){return paused},resume:function(){i.addStream(p),this._updateDescription(),h=!0},mute:function(){},getId:function(){return c},setId:function(e){g=!1,c=e},setIceServers:function(e){typeof e=="array"?_ice_servers=e:_ice_servers=[e]},isStreaming:function(){return _streaming},_startLocalStream:function(e){getUserMedia({audio:!0,video:!0},function(t){p=t,attachMediaStream(f,p),e()})},_startDataChannel:function(e){b[e]=y[e].createDataChannel("test",{reliable:!1}),b[0]!==undefined&&b[0].onmessage!==undefined?b[e].onmessage=function(e){var t=e.data.indexOf(","),n=e.data.substring(0,t),r=e.data.substring(t+1);uriContent="data:application/octet-stream; filename="+n+","+encodeURIComponent(r),location.href=uriContent}:b[e].onmessage=function(e){var t=e.data.indexOf(","),n=e.data.substring(0,t),r=e.data.substring(t+1);uriContent="data:application/octet-stream; filename="+n+","+encodeURIComponent(r),location.href=uriContent},b[e].onopen=function(){v=!0;var t;for(t=0;t<m.length;t++)b[e].send(m[t])}},_createConn:function(e,t){var n={iceServers:[a]},r={optional:[{RtpDataChannels:!0}]};y[t]=new RTCPeerConnection(n,r),this._startDataChannel(t),y[t].addStream(p),this._updateDescription(y[t],e,t)},_makeConnection:function(e,t){var r=this;n.emit("join",{id:c}),n.on("joined",function(t){client_id=t.client_id,s=t.id,client_id!=0&&r._createConn(client_id,0),e(s)}),n.on("add_desc",function(e){client_id=e.from_client_id,s=e.id,console.log(e.client_id+" <------ "+client_id);var t=!1;if(y[client_id]===undefined){console.log("craeting one for, "+client_id);var i={iceServers:[a]},o={optional:[{RtpDataChannels:!0}]};y[client_id]=new RTCPeerConnection(i,o),r._startDataChannel(client_id),t=!0,y[client_id].addStream(p)}y[client_id].onaddstream=function(e){console.log("2"),d[d.length]=e.stream,attachMediaStream(l[l.length-1],d[d.length-1]),h=!0},y[client_id].onicecandidate=function(t){t.candidate&&n.emit("cand",{client_id:client_id,from_client_id:e.client_id,cand:t.candidate,id:s})},y[client_id].setRemoteDescription(new RTCSessionDescription(e.desc)),_streaming=!0,t&&(console.log("owner"),y[client_id].createAnswer(function(t){y[client_id].setLocalDescription(t),console.log(e.client_id+" ------> "+e.from_client_id),n.emit("desc",{client_id:e.from_client_id,from_client_id:e.client_id,desc:t,id:s})}));var u;E[client_id]!==undefined&&console.log("numcand"+E[client_id].length);for(u=0;E[client_id]!==undefined&&u<E[client_id].length;u++)y[client_id].addIceCandidate(new RTCIceCandidate(E[u]));w(),console.log(e.client_id+" "+(client_id+1)),t||e.client_id>client_id+1&&r._createConn(e.client_id,client_id+1)}),n.on("add_cand",function(e){y[e.client_id]===undefined?(E[e.client_id]===undefined&&(E[e.client_id]=[]),E[e.client_id].push(e.cand)):y[e.client_id].addIceCandidate(new RTCIceCandidate(e.cand))})},_updateDescription:function(e,t,r){e.createOffer(function(i){e.setLocalDescription(i),console.log(t+" ------> "+r),n.emit("desc",{client_id:r,from_client_id:t,desc:i,id:s})},null)},onConnection:function(e){w=e}},e.WebRTC=S},"@VERSION@",{requires:["node","socket_io"]});
