YUI.add("webrtc",function(e,t){function w(){}var n=io.connect("/"),r,i,s,o,u=-1,a={url:"stun:stun.l.google.com:19302"},f=null,l=[],c="",h=!1,p=null,d=[],v=!1,m=[],g=!0,y=[],b=null;w.prototype={startStream:function(e,t){var n=this;(e==="both"||e==="media"||typeof e===undefined)&&n._startLocalStream(function(){n._makeConnection(t)})},onMessage:function(e){},send:function(e){v?o.send(e):m.push(e)},setLocal:function(e){f=document.getElementById(e)},addRemote:function(e){l.push(document.getElementById(e))},pause:function(){i.removeStream(p),this._updateDescription(),h=!1},isStreaming:function(){return paused},resume:function(){i.addStream(p),this._updateDescription(),h=!0},mute:function(){},getId:function(){return c},setId:function(e){g=!1,c=e},setIceServers:function(e){typeof e=="array"?_ice_servers=e:_ice_servers=[e]},isStreaming:function(){return _streaming},_startLocalStream:function(e){getUserMedia({audio:!0,video:!0},function(t){p=t,attachMediaStream(f,p),e()})},_startDataChannel:function(){o.onmessage=null,o.onopen=function(){v=!0;var e;for(e=0;e<m.length;e++)o.send(m[e])}},_makeConnection:function(e,t){var r=this;n.emit("join",{id:c}),n.on("joined",function(t){client_id=t.client_id,s=t.id,console.log("joined");var i;for(i=0;i<client_id;i++){var o={iceServers:[a]},u={optional:[{RtpDataChannels:!0}]};y[i]=new RTCPeerConnection(o,u);var f=i;y[i].onicecandidate=function(e){console.log("onicecandidate"),e.candidate&&n.emit("cand",{client_id:i,from_client_id:client_id,cand:e.candidate,id:s})},y[i].onaddstream=function(e){d[d.length]=e.stream,attachMediaStream(l[l.length-1],d[d.length-1]),h=!0},y[i].addStream(p),r._updateDescription(y[i],i)}e(s)}),n.on("add_desc",function(e){client_id=e.from_client_id,s=e.id,console.log("adddesc"+client_id);var t=!1;if(y[client_id]===undefined){var r={iceServers:[a]},i={optional:[{RtpDataChannels:!0}]};y[client_id]=new RTCPeerConnection(r,i),t=!0}console.log("before"),y[client_id].addStream(p),console.log("before2"),y[client_id].onaddstream=function(e){d[d.length]=e.stream,attachMediaStream(l[l.length-1],d[d.length-1]),h=!0},console.log("before3");var o=client_id;y[client_id].onicecandidate=function(t){console.log("onicecandidatehere"),t.candidate&&n.emit("cand",{client_id:client_id,from_client_id:e.client_id,cand:t.candidate,id:s})},console.log("before4"+client_id),console.log(e),y[client_id]!==undefined&&y[client_id].setRemoteDescription(new RTCSessionDescription(e.desc)),console.log("after"),_streaming=!0;var o=client_id;console.log(o),console.log("before5"),t&&y[o].createAnswer(function(t){console.log("in here"),y[o].setLocalDescription(t),console.log(e.client_id+" ---------------> "+e.from_client_id),n.emit("desc",{client_id:e.from_client_id,from_client_id:e.client_id,desc:t,id:s,numConn:o})}),b()}),n.on("add_cand",function(e){console.log("test"),console.log(new RTCIceCandidate(e.cand)),console.log(e.client_id),y[e.client_id].addIceCandidate(new RTCIceCandidate(e.cand))})},_updateDescription:function(e,t){e.createOffer(function(r){e.setLocalDescription(r),console.log(client_id+" ---------------> "+t),n.emit("desc",{client_id:t,from_client_id:client_id,desc:r,id:s})},null)},onConnection:function(e){b=e}},e.WebRTC=w},"@VERSION@",{requires:["node","socket_io"]});
