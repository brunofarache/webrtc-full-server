YUI.add("webrtc",function(e,t){function n(){}n.prototype={socket:io.connect("/"),DEFAULT_STUN_SERVER:{url:"stun:stun.l.google.com:19302"},_localStreamElement:null,_remoteStreamElements:[],_roomId:"",_isStreaming:!1,_localStream:null,_remoteStreams:[],_disconnectedMessages:[],_pcs:[],_dcs:[],_newConnectionCallback:null,_type:"both",_downloadStatus:0,_download:"",_downloadName:"",startStream:function(e,t){var n=this;this._type=e|this._type,e==="both"||e==="media"||typeof e===undefined?n._startLocalStream(function(){n._makeConnection(t)}):n._makeConnection(t)},onMessage:function(e){var t;for(t=0;t<this._dcs.length;t++)this._dcs[t].onmessage=e},send:function(e){var t;for(t=0;t<this._dcs.length;t++)this._dcs[t]!==undefined?(this._dcs[t].send(e),console.log("test")):this._disconnectedMessages.push(e)},sendFile:function(e){var t=this,n=new FileReader,r=document.getElementById(e).files[0];n.onload=function(n){var i=document.getElementById(e).value.split(/(\/|\\)/).pop(),s=r.size,o=500,u=Math.ceil(s/o);t.send("start"+u+","+i);var a=0;for(var f=0;f<u;f++)setTimeout(function(){t.send(n.target.result.substring(a*o,a*o+o)),a++},(f+1)*200)},n.readAsText(r)},setLocal:function(e){console.log("test"+e),this._localStreamElement=document.getElementById(e),console.log(this._localStreamElement)},addRemote:function(e){this._remoteStreamElements.push(document.getElementById(e))},pause:function(){this._pcs[0].removeStream(this._localStream),this._updateDescription(),this._isStreaming=!1},isStreaming:function(){return paused},resume:function(){this._pcs[0].addStream(this._localStream),this._updateDescription(),this._isStreaming=!0},mute:function(){},getId:function(){return this._roomId},setId:function(e){_owner=!1,this._roomId=e},setIceServers:function(e){typeof e=="array"?_ice_servers=e:_ice_servers=[e]},isStreaming:function(){return _streaming},_getLocalStream:function(){return this._localStream},_getRemoteStreams:function(){return this._remoteStreams},_startLocalStream:function(e){thisWebRTC=this,getUserMedia({audio:!0,video:!0},function(t){thisWebRTC._localStream=t,console.log(thisWebRTC._localStreamElement),attachMediaStream(thisWebRTC._localStreamElement,thisWebRTC._localStream),e()})},_startDataChannel:function(t){thisWebRTC=this,this._dcs[t]=this._pcs[t].createDataChannel("test",{reliable:!1}),this._dcs[0]!==undefined&&this._dcs[0].onmessage!==undefined?this._dcs[t].onmessage=function(t){if(thisWebRTC._downloadStatus>0)console.log(this._downloadStatus),thisWebRTC._download+=t.data,thisWebRTC._downloadStatus--,thisWebRTC._downloadStatus==0&&(uriContent="data:application/octet-stream,"+encodeURIComponent(this._download),e.one("body").append('<a style="position:absolute;display:none" id="webrtc-file-download" href="'+uriContent+'" download="'+this._downloadName+'"></a>'),e.one("#webrtc-file-download").simulate("click"),thisWebRTC._download="");else if(t.data.substring(0,5)==="start"){var n=t.data.indexOf(",");thisWebRTC._downloadStatus=parseInt(t.data.substring(5,n)),thisWebRTC._downloadName=t.data.substring(n+1),console.log(thisWebRTC._downloadStatus+" "+thisWebRTC._downloadName)}}:this._dcs[t].onmessage=function(e){var t=e.data.indexOf(","),n=e.data.substring(0,t),r=e.data.substring(t+1);uriContent="data:application/octet-stream; filename="+n+","+encodeURIComponent(r),location.href=uriContent},this._dcs[t].onopen=function(){_isDataChannelOpen=!0;var e;for(e=0;e<thisWebRTC._disconnectedMessages.length;e++)thisWebRTC._dcs[t].send(thisWebRTC._disconnectedMessages[e])}},_createConn:function(e,t){var n={iceServers:[this.DEFAULT_STUN_SERVER]},r={optional:[{RtpDataChannels:!0}]};this._pcs[t]=new RTCPeerConnection(n,r),this._startDataChannel(t),this._pcs[t].addStream(this._localStream),this._updateDescription(this._pcs[t],e,t)},_makeConnection:function(e,t){var n=this;this.socket.on("joined",function(t){client_id=t.client_id,id=t.id,client_id!=0&&n._createConn(client_id,0),e(id)}),this.socket.on("add_desc",function(e){client_id=e.from_client_id,id=e.id,console.log(e.client_id+" <------ "+client_id);var t=!1;if(n._pcs[client_id]===undefined){console.log("creating one for, "+client_id);var r={iceServers:[n.DEFAULT_STUN_SERVER]},i={optional:[{RtpDataChannels:!0}]};n._pcs[client_id]=new RTCPeerConnection(r,i),n._startDataChannel(client_id),t=!0,n._localStream&&n._pcs[client_id].addStream(n._localStream)}n._pcs[client_id].onaddstream=function(e){console.log("2"),n._remoteStreams[n._remoteStreams.length]=e.stream,console.log("3"),attachMediaStream(n._remoteStreamElements[n._remoteStreamElements.length-1],n._remoteStreams[n._remoteStreams.length-1]),console.log("4"),n._isStreaming=!0},n._pcs[client_id].onicecandidate=function(t){t.candidate&&n.socket.emit("cand",{client_id:client_id,from_client_id:e.client_id,cand:t.candidate,id:id})},n._pcs[client_id].setRemoteDescription(new RTCSessionDescription(e.desc)),_streaming=!0,t&&(console.log("owner"),n._pcs[client_id].createAnswer(function(t){console.log("after owner"),n._pcs[client_id].setLocalDescription(t),console.log(e.client_id+" ------> "+e.from_client_id),n.socket.emit("desc",{client_id:e.from_client_id,from_client_id:e.client_id,desc:t,id:id})})),n._newConnectionCallback(),console.log(e.client_id+" "+(client_id+1)),t||e.client_id>client_id+1&&n._createConn(e.client_id,client_id+1)}),this.socket.on("add_cand",function(e){n._pcs[e.client_id]===undefined?(cands[e.client_id]===undefined&&(cands[e.client_id]=[]),cands[e.client_id].push(e.cand)):n._pcs[e.client_id].addIceCandidate(new RTCIceCandidate(e.cand))}),this.socket.emit("join",{id:this._roomId})},_updateDescription:function(e,t,n){thisWebRTC=this,e.createOffer(function(r){e.setLocalDescription(r),console.log(t+" ------> "+n),thisWebRTC.socket.emit("desc",{client_id:n,from_client_id:t,desc:r,id:id})},null)},onConnection:function(e){this._newConnectionCallback=e}},e.WebRTC=n},"@VERSION@",{requires:["node","socket_io"]});
